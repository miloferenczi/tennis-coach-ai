<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACE - AI Coach</title>
    <meta name="description" content="AI-powered athletic coaching with real-time pose analysis">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0A0A0A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ACE">

    <!-- Premium Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Link to manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
        
        <!-- Add these new scripts in order -->
    <script src="js/physics-analyzer.js"></script>
    <script src="js/stroke-classifier.js"></script>
    <script src="js/professional-references.js"></script>
    <script src="js/coaching-orchestrator.js"></script>
    <script src="js/phase-detector.js"></script>
    <script src="js/kinetic-chain-analyzer.js"></script>
    <script src="js/motion-sequence-analyzer.js"></script>
    <script src="js/biomechanical-checkpoints.js"></script>
    <script src="js/diagnostic-logger.js"></script>
    <script src="js/calibration-tool.js"></script>
    <script src="js/threshold-updater.js"></script>

    <!-- Sport Configuration -->
    <script src="js/sport-loader.js"></script>

    <!-- Application Scripts -->
    <script src="js/session-storage.js"></script>
    <script src="js/player-profile.js"></script>
    <script src="js/ghost-overlay.js"></script>
    <script src="js/challenge-mode.js"></script>
    <script src="js/enhanced-tennis-analyzer.js"></script>
    <script src="js/gpt-voice-coach.js"></script>
    <script src="js/video-analyzer.js"></script>

    <style>
        /* ============================================
           PREMIUM DESIGN SYSTEM - Nike/Athletic Aesthetic
           ============================================ */

        :root {
            /* Color System */
            --bg-primary: #0A0A0A;
            --bg-secondary: #141414;
            --bg-surface: rgba(255, 255, 255, 0.06);
            --accent-volt: #CDFF00;
            --text-primary: #F5F5F5;
            --text-muted: #8A8A8A;
            --text-subtle: #666666;
            --danger: #FF3B30;
            --success: #32D74B;
            --warning: #FF9500;
            --border-subtle: rgba(255, 255, 255, 0.08);

            /* Glass Effect */
            --glass-bg: rgba(10, 10, 10, 0.75);
            --glass-blur: blur(20px);

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
        }

        /* Noise/Grain Texture Overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            z-index: 10000;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .camera-container {
            position: relative;
            flex: 1;
            background: var(--bg-primary);
            overflow: hidden;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #canvasElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        /* ============================================
           SCREENS (Permission, API Key, Loading)
           ============================================ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            z-index: 1001;
        }

        .screen-title {
            font-size: 56px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.03em;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .screen-subtitle {
            font-size: 16px;
            font-weight: 400;
            color: var(--text-muted);
            margin-bottom: 48px;
            text-transform: lowercase;
        }

        .screen-text {
            font-size: 15px;
            margin-bottom: 32px;
            color: var(--text-muted);
            line-height: 1.5;
            max-width: 320px;
        }

        .powered-by {
            position: absolute;
            bottom: 40px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-primary);
            opacity: 0.3;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            background: var(--accent-volt);
            color: var(--bg-primary);
            border: none;
            padding: 16px 40px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.15s ease;
            font-family: var(--font-family);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 12px 24px;
        }

        .btn-ghost:hover {
            color: var(--text-primary);
        }

        /* ============================================
           INPUTS
           ============================================ */
        input[type="password"],
        input[type="text"] {
            width: 100%;
            max-width: 360px;
            padding: 16px 20px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            color: var(--text-primary);
            font-size: 15px;
            font-family: var(--font-family);
            margin: 20px 0;
            backdrop-filter: var(--glass-blur);
            transition: border-color 0.2s ease;
        }

        input[type="password"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-volt);
        }

        input[type="password"]::placeholder,
        input[type="text"]::placeholder {
            color: var(--text-subtle);
        }

        /* ============================================
           LOADING SCREEN
           ============================================ */
        .loading-screen {
            z-index: 1000;
        }

        .loading-text {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .loading-progress {
            width: 200px;
            height: 2px;
            background: var(--bg-surface);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: var(--accent-volt);
            border-radius: var(--radius-full);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ============================================
           STATUS BAR (Top HUD)
           ============================================ */
        .status-bar {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            right: var(--space-md);
            display: flex;
            justify-content: space-between;
            z-index: 100;
            background: var(--glass-bg);
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
        }

        .status-item {
            text-align: center;
            flex: 1;
        }

        .status-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-subtle);
            margin-bottom: 6px;
        }

        .status-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .status-value.muted {
            color: var(--text-subtle);
        }

        .ai-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-subtle);
        }

        .status-dot.ready {
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: var(--accent-volt);
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 12px rgba(205, 255, 0, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ============================================
           ANALYSIS CARD
           ============================================ */
        .analysis-card {
            position: absolute;
            top: 100px;
            right: var(--space-md);
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            min-width: 180px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            transform: scale(0) translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 320px;
            overflow-y: auto;
            z-index: 100;
        }

        .analysis-card.visible {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .stroke-type {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-volt);
            margin-bottom: 8px;
            text-align: center;
        }

        .technique-score {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 4px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .score-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-subtle);
            text-align: center;
            margin-bottom: 16px;
        }

        .advanced-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .metric-item {
            text-align: center;
        }

        .metric-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-subtle);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        /* ============================================
           COACHING PANEL
           ============================================ */
        .coaching-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-top: 1px solid var(--border-subtle);
            max-height: 30vh;
            overflow-y: auto;
            z-index: 100;
        }

        .coaching-drag-handle {
            width: 36px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            margin: 0 auto 16px;
        }

        .coaching-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .coaching-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-volt);
        }

        .coaching-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-volt);
            animation: pulse 1.5s infinite;
        }

        .coaching-text {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
            font-weight: 400;
        }

        /* ============================================
           CONTROLS
           ============================================ */
        .controls {
            position: absolute;
            bottom: calc(160px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 24px;
            z-index: 100;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            box-shadow: 0 0 0 2px var(--accent-volt);
        }

        .control-btn-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-top: 8px;
            position: absolute;
            bottom: -24px;
            white-space: nowrap;
        }

        .play-btn.recording {
            box-shadow: 0 0 0 2px var(--accent-volt), 0 0 20px rgba(205, 255, 0, 0.3);
        }

        /* Icon styling */
        .control-icon {
            font-size: 22px;
            line-height: 1;
        }

        /* ============================================
           MODE SWITCHER (Tab Bar)
           ============================================ */
        .mode-switcher {
            position: absolute;
            top: calc(90px + var(--space-md));
            left: var(--space-md);
            display: flex;
            background: var(--glass-bg);
            border-radius: var(--radius-full);
            padding: 4px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            z-index: 100;
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }

        .mode-btn.active {
            background: var(--accent-volt);
            color: var(--bg-primary);
        }

        .mode-btn:not(.active):hover {
            color: var(--text-primary);
        }

        /* ============================================
           ERROR MESSAGE
           ============================================ */
        .error-message {
            background: var(--danger);
            color: white;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        /* ============================================
           STROKE FLASH OVERLAY
           ============================================ */
        .stroke-flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9998;
            opacity: 0;
        }

        .stroke-flash-overlay.flash {
            animation: borderFlash 0.5s ease-out forwards;
        }

        .stroke-flash-overlay.great {
            box-shadow: inset 0 0 120px 40px rgba(205, 255, 0, 0.6);
        }

        .stroke-flash-overlay.good {
            box-shadow: inset 0 0 120px 40px rgba(255, 149, 0, 0.5);
        }

        .stroke-flash-overlay.needs-work {
            box-shadow: inset 0 0 120px 40px rgba(255, 59, 48, 0.5);
        }

        @keyframes borderFlash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ============================================
           GHOST OVERLAY STYLES
           ============================================ */
        .ghost-similarity {
            position: fixed;
            top: 140px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
            text-align: center;
            z-index: 100;
        }

        .ghost-similarity-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .ghost-similarity-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-volt);
        }

        .ghost-similarity-value.low {
            color: #f44336;
        }

        .ghost-similarity-value.medium {
            color: #FF9800;
        }

        .ghost-similarity-value.high {
            color: var(--accent-volt);
        }

        #ghostBtn.active {
            background: var(--accent-volt);
            color: #0A0A0A;
        }

        #ghostBtn.active .control-icon {
            filter: none;
        }

        /* ============================================
           PRO COMPARISON STYLES
           ============================================ */
        .pro-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pro-card:hover {
            background: rgba(205, 255, 0, 0.1);
            border-color: var(--accent-volt);
        }

        .pro-card.selected {
            background: rgba(205, 255, 0, 0.15);
            border-color: var(--accent-volt);
        }

        .pro-name {
            font-weight: 700;
            color: white;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .pro-style {
            font-size: 11px;
            color: var(--text-muted);
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .comparison-metric:last-child {
            border-bottom: none;
        }

        .comparison-metric-label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .comparison-metric-values {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .comparison-you {
            color: white;
            font-weight: 600;
        }

        .comparison-vs {
            color: var(--text-muted);
            font-size: 11px;
        }

        .comparison-pro {
            color: var(--accent-volt);
            font-weight: 600;
        }

        .comparison-diff {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .comparison-diff.positive {
            background: rgba(205, 255, 0, 0.2);
            color: var(--accent-volt);
        }

        .comparison-diff.negative {
            background: rgba(255, 59, 48, 0.2);
            color: #f44336;
        }

        /* ============================================
           CHALLENGE MODE STYLES
           ============================================ */
        .active-challenge-bar {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
        }

        .challenge-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .challenge-icon {
            font-size: 16px;
        }

        .challenge-name {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .challenge-progress-bar {
            width: 80px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-volt);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .challenge-progress-text {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 30px;
        }

        .challenge-complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            animation: fadeIn 0.3s ease;
        }

        .challenge-complete-content {
            text-align: center;
            padding: 40px;
        }

        .challenge-complete-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounceIn 0.5s ease;
        }

        .challenge-complete-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-volt);
            margin-bottom: 12px;
        }

        .challenge-complete-name {
            font-size: 18px;
            color: white;
            margin-bottom: 8px;
        }

        .challenge-complete-reward {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .challenge-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .challenge-card:hover {
            border-color: var(--accent-volt);
            background: rgba(205, 255, 0, 0.05);
        }

        .challenge-card.completed {
            opacity: 0.6;
            border-color: var(--accent-volt);
        }

        .challenge-card.active {
            border-color: var(--accent-volt);
            background: rgba(205, 255, 0, 0.1);
        }

        .challenge-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .challenge-card-icon {
            font-size: 24px;
        }

        .challenge-card-title {
            font-weight: 700;
            color: white;
            font-size: 15px;
        }

        .challenge-card-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .challenge-card-difficulty {
            font-size: 10px;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .challenge-card-difficulty.easy {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .challenge-card-difficulty.medium {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        .challenge-card-difficulty.hard {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .challenge-card-badge {
            font-size: 11px;
            color: var(--accent-volt);
            margin-left: auto;
        }

        /* ============================================
           MODAL STYLES
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 28px;
            max-width: 480px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-subtle);
        }

        .modal-overlay.visible .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            color: var(--text-primary);
        }

        .modal-close {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .summary-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-stat.highlight {
            grid-column: span 2;
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .summary-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 4px;
        }

        .summary-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
        }

        .summary-section {
            margin-bottom: 20px;
        }

        .summary-section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-volt, #CDFF00);
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .weakness-tag {
            display: inline-block;
            background: rgba(255, 152, 0, 0.3);
            color: #FFC107;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            margin: 4px 4px 4px 0;
        }

        .drill-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-volt, #CDFF00);
        }

        .drill-name {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
        }

        .drill-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .drill-duration {
            font-size: 12px;
            color: var(--accent-volt, #CDFF00);
        }

        .improvement-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
        }

        .improvement-badge.positive {
            background: rgba(76, 175, 80, 0.3);
            color: var(--accent-volt, #CDFF00);
        }

        .improvement-badge.negative {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .improvement-badge.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        /* Mode Switcher */
        .mode-switcher {
            position: absolute;
            top: 80px;
            left: 20px;
            display: flex;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            padding: 4px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 500;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent-volt, #CDFF00);
            color: #0A0A0A;
        }

        .mode-btn:hover:not(.active) {
            color: var(--text-primary, #F5F5F5);
        }

        /* Analysis Mode Container */
        .analysis-mode-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            background: var(--bg-primary, #0A0A0A);
        }

        .analysis-mode-container.active {
            display: flex;
        }

        .video-upload-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-secondary, #141414);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed var(--border-subtle, rgba(255,255,255,0.1));
            margin: 16px;
            border-radius: var(--radius-lg, 16px);
        }

        .video-upload-zone.dragover {
            border-color: var(--accent-volt, #CDFF00);
            background: rgba(205, 255, 0, 0.05);
        }

        .video-upload-zone.has-video {
            display: none;
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Video Player Area */
        .video-player-area {
            flex: 1;
            position: relative;
            display: none;
            background: #000;
        }

        .video-player-area.active {
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #analysisVideo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #analysisCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Timeline */
        .timeline-container {
            background: rgba(0, 0, 0, 0.9);
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .timeline-time {
            font-size: 14px;
            color: white;
            font-family: monospace;
            min-width: 100px;
        }

        .timeline-playback-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--accent-volt, #CDFF00);
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .timeline-track {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
        }

        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }

        .timeline-playhead {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-volt, #CDFF00);
            border-radius: 2px;
            pointer-events: none;
        }

        .stroke-marker {
            position: absolute;
            top: 4px;
            bottom: 4px;
            width: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stroke-marker:hover {
            transform: scaleY(1.2);
        }

        .stroke-marker.forehand {
            background: var(--accent-volt, #CDFF00);
        }

        .stroke-marker.backhand {
            background: var(--accent-volt, #CDFF00);
        }

        .stroke-marker.serve {
            background: #FF9800;
        }

        .stroke-marker.volley {
            background: #9C27B0;
        }

        .stroke-marker.selected {
            box-shadow: 0 0 0 2px white;
        }

        /* Stroke Details Panel */
        .stroke-details-panel {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 16px;
            padding: 16px;
            min-width: 200px;
            max-width: 280px;
            backdrop-filter: blur(10px);
            transform: translateX(320px);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .stroke-details-panel.visible {
            transform: translateX(0);
        }

        #comparisonPanel {
            left: 20px;
            right: auto;
            transform: translateX(-320px);
        }

        #comparisonPanel.visible {
            transform: translateX(0);
        }

        .stroke-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stroke-details-type {
            font-size: 16px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .stroke-details-score {
            font-size: 24px;
            font-weight: bold;
        }

        .stroke-details-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stroke-metric {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stroke-metric-value {
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .stroke-metric-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Analysis Progress */
        .analysis-progress-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .analysis-progress-overlay.active {
            display: flex;
        }

        .analysis-progress-text {
            font-size: 18px;
            color: white;
            margin-bottom: 20px;
        }

        .analysis-progress-bar {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .analysis-progress-fill {
            height: 100%;
            background: var(--accent-volt, #CDFF00);
            width: 0%;
            transition: width 0.2s;
        }

        @media (max-width: 480px) {
            .status-bar {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 10px 12px;
            }

            .analysis-card {
                top: 120px;
                right: 10px;
                padding: 12px;
                min-width: 140px;
            }

            .coaching-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
                max-height: 120px;
            }

            .controls {
                bottom: 140px;
                gap: 15px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Permission Screen -->
        <div id="permissionScreen" class="screen">
            <img src="ace-ai-logo.svg" alt="ACE" class="logo" style="width: 80px; height: 80px; margin-bottom: 24px;">
            <div class="screen-title">ACE</div>
            <div class="screen-subtitle">ai-powered stroke analysis</div>
            <div class="screen-text">
                Real-time coaching powered by computer vision.<br>
                Camera access required to analyze your form.
            </div>
            <button class="btn" onclick="requestCameraPermission()">
                START SESSION â†’
            </button>
            <div class="powered-by">powered by computer vision</div>
        </div>

        <!-- API Key Screen -->
        <div id="apiKeyScreen" class="screen" style="display: none;">
            <div class="screen-title">CONNECT</div>
            <div class="screen-subtitle">enable voice coaching</div>
            <div class="screen-text">
                Enter your OpenAI API key for real-time voice feedback.<br>
                <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent-volt); text-decoration: none;">Get your key â†’</a>
            </div>
            <input
                type="password"
                id="apiKeyInput"
                placeholder="sk-..."
            />
            <button class="btn" onclick="connectGPTCoach()">
                CONNECT â†’
            </button>
            <button class="btn-ghost" onclick="skipGPTCoach()" style="margin-top: 16px;">
                Skip for now
            </button>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen loading-screen" style="display: none;">
            <img src="ace-ai-logo.svg" alt="ACE" class="logo" style="width: 64px; height: 64px; margin-bottom: 32px; animation: pulse 2s infinite;">
            <div class="loading-text" id="loadingStatus">INITIALIZING</div>
            <div class="loading-progress">
                <div id="loadingBar" class="loading-bar"></div>
            </div>
        </div>

        <!-- Main Camera Interface -->
        <div class="camera-container" style="display: none;" id="cameraContainer">
            <video id="videoElement" playsinline autoplay muted></video>
            <canvas id="canvasElement"></canvas>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-label">STROKES</div>
                    <div class="status-value" id="strokeCount">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">AVG SCORE</div>
                    <div class="status-value muted" id="avgScore">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">CONSISTENCY</div>
                    <div class="status-value muted" id="consistencyScore">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">AI COACH</div>
                    <div class="ai-status">
                        <div id="aiStatusDot" class="status-dot"></div>
                    </div>
                </div>
            </div>

            <!-- Analysis Card -->
            <div id="analysisCard" class="analysis-card">
                <div id="strokeType" class="stroke-type">FOREHAND</div>
                <div id="techniqueScore" class="technique-score">85</div>
                <div class="score-label">SCORE</div>

                <div class="advanced-metrics">
                    <div class="metric-item">
                        <div class="metric-label">ELBOW</div>
                        <div class="metric-value" id="elbowAngleMetric">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">ROTATION</div>
                        <div class="metric-value" id="hipSepMetric">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">STANCE</div>
                        <div class="metric-value" id="stanceMetric">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">WEIGHT</div>
                        <div class="metric-value" id="weightMetric">--</div>
                    </div>

                    <div class="metric-item" style="grid-column: span 2;">
                        <div class="metric-label">LEVEL</div>
                        <div class="metric-value" id="skillLevelMetric" style="color: var(--accent-volt);">--</div>
                    </div>
                </div>
            </div>

            <!-- Ghost Similarity Display -->
            <div id="ghostSimilarityDisplay" class="ghost-similarity" style="display: none;">
                <div class="ghost-similarity-label">GHOST MATCH</div>
                <div class="ghost-similarity-value" id="ghostSimilarityValue">--</div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                    <button class="control-btn" onclick="showAnalytics()" title="View History">
                        <span class="control-icon">ðŸ“Š</span>
                    </button>
                    <span class="control-btn-label">STATS</span>
                </div>
                <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                    <button id="ghostBtn" class="control-btn" onclick="toggleGhost()" title="Ghost Overlay">
                        <span class="control-icon">ðŸ‘»</span>
                    </button>
                    <span class="control-btn-label" id="ghostBtnLabel">GHOST</span>
                </div>
                <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                    <button id="playBtn" class="control-btn play-btn" onclick="toggleAnalysis()">
                        <span class="control-icon">â–¶</span>
                    </button>
                    <span class="control-btn-label">RECORD</span>
                </div>
                <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                    <button class="control-btn" onclick="resetSession()">
                        <span class="control-icon">â†º</span>
                    </button>
                    <span class="control-btn-label">RESET</span>
                </div>
            </div>

            <!-- Coaching Panel -->
            <div class="coaching-panel">
                <div class="coaching-drag-handle"></div>
                <div class="coaching-header">
                    <span class="coaching-label">AI COACH</span>
                    <span class="coaching-dot"></span>
                </div>
                <div id="coachingText" class="coaching-text">
                    Ready. Stand in frame and swing to begin analysis.
                </div>
            </div>

            <!-- Mode Switcher -->
            <div class="mode-switcher">
                <button class="mode-btn active" id="practiceModeBtn" onclick="switchMode('practice')">Practice</button>
                <button class="mode-btn" id="analysisModeBtn" onclick="switchMode('analysis')">Analysis</button>
                <button class="mode-btn" onclick="showChallenges()" title="Challenges">ðŸ†</button>
                <button class="mode-btn" onclick="showProComparison()" title="Compare to pro players">Pro</button>
                <button class="mode-btn" id="calibrateModeBtn" onclick="openCalibrationModal()" title="Calibrate with pro videos">Cal</button>
            </div>

            <!-- Analysis Mode Container -->
            <div class="analysis-mode-container" id="analysisModeContainer">
                <!-- Video Upload Zone -->
                <div class="video-upload-zone" id="videoUploadZone">
                    <div class="upload-icon">ðŸŽ¬</div>
                    <div class="upload-text">Drop a video here or click to upload</div>
                    <div class="upload-subtext">Supports MP4, MOV, WebM</div>
                    <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
                </div>

                <!-- Video Player Area -->
                <div class="video-player-area" id="videoPlayerArea">
                    <div class="video-container">
                        <video id="analysisVideo" playsinline></video>
                        <canvas id="analysisCanvas"></canvas>
                    </div>

                    <!-- Timeline -->
                    <div class="timeline-container">
                        <div class="timeline-controls">
                            <button class="timeline-playback-btn" id="timelinePlayBtn" onclick="toggleVideoPlayback()">â–¶ï¸</button>
                            <span class="timeline-time" id="timelineTime">0:00 / 0:00</span>
                            <div style="margin-left: auto; display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="exportHighlightReel()" style="padding: 8px 12px; font-size: 11px;" title="Export best 5 strokes">
                                    Best 5
                                </button>
                                <button class="btn btn-secondary" onclick="exportBlooperReel()" style="padding: 8px 12px; font-size: 11px;" title="Export worst 5 for learning">
                                    Learn 5
                                </button>
                                <button class="btn btn-secondary" onclick="clearAnalysisVideo()" style="padding: 8px 12px; font-size: 11px;">
                                    New
                                </button>
                            </div>
                        </div>
                        <div class="timeline-track" id="timelineTrack">
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <div class="timeline-playhead" id="timelinePlayhead"></div>
                            <!-- Stroke markers will be inserted here -->
                        </div>
                    </div>

                    <!-- Stroke Details Panel -->
                    <div class="stroke-details-panel" id="strokeDetailsPanel">
                        <div class="stroke-details-header">
                            <span class="stroke-details-type" id="strokeDetailType">Forehand</span>
                            <span class="stroke-details-score" id="strokeDetailScore" style="color: var(--accent-volt, #CDFF00);">85</span>
                        </div>
                        <div class="stroke-details-metrics">
                            <div class="stroke-metric">
                                <div class="stroke-metric-value" id="strokeDetailTime">0:00</div>
                                <div class="stroke-metric-label">Time</div>
                            </div>
                            <div class="stroke-metric">
                                <div class="stroke-metric-value" id="strokeDetailVelocity">--</div>
                                <div class="stroke-metric-label">Velocity</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="addToComparison()" style="flex: 1; padding: 8px; font-size: 11px;" id="compareBtn">
                                + Compare
                            </button>
                            <button class="btn btn-secondary" onclick="hideStrokeDetails()" style="padding: 8px 12px; font-size: 11px;">
                                Ã—
                            </button>
                        </div>
                    </div>

                    <!-- Comparison Panel -->
                    <div class="stroke-details-panel" id="comparisonPanel" style="left: 20px; right: auto; transform: translateX(-320px);">
                        <div style="font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 12px; color: var(--accent-volt);">
                            Comparing 2 Strokes
                        </div>
                        <div id="comparisonContent">
                            <!-- Dynamic comparison content -->
                        </div>
                        <button class="btn btn-secondary" onclick="clearComparison()" style="width: 100%; margin-top: 12px; padding: 8px; font-size: 11px;">
                            Clear Comparison
                        </button>
                    </div>

                    <!-- Analysis Progress Overlay -->
                    <div class="analysis-progress-overlay" id="analysisProgressOverlay">
                        <div class="analysis-progress-text">Analyzing video...</div>
                        <div class="analysis-progress-bar">
                            <div class="analysis-progress-fill" id="analysisProgressFill"></div>
                        </div>
                        <div style="margin-top: 12px; font-size: 14px; color: rgba(255,255,255,0.6);" id="analysisProgressPercent">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Container -->
        <div id="errorContainer"></div>

        <!-- Stroke Quality Flash Overlay -->
        <div id="strokeFlashOverlay" class="stroke-flash-overlay"></div>

        <!-- Session Summary Modal -->
        <div id="sessionSummaryModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">Session Complete</div>
                    <button class="modal-close" onclick="closeSessionSummary()">&times;</button>
                </div>
                <div id="sessionSummaryContent">
                    <!-- Dynamic content inserted here -->
                </div>
                <button class="btn" onclick="closeSessionSummary()" style="width: 100%; margin-top: 16px;">
                    Start New Session
                </button>
            </div>
        </div>

        <!-- Analytics Modal -->
        <div id="analyticsModal" class="modal-overlay">
            <div class="modal" style="max-width: 560px;">
                <div class="modal-header">
                    <div class="modal-title">Session History</div>
                    <button class="modal-close" onclick="closeAnalytics()">&times;</button>
                </div>
                <div id="analyticsContent">
                    <!-- Dynamic content inserted here -->
                </div>
            </div>
        </div>

        <!-- Active Challenge Display -->
        <div id="activeChallengeBar" class="active-challenge-bar" style="display: none;">
            <div class="challenge-info">
                <span class="challenge-icon" id="activeChallengeIcon">ðŸ‘‘</span>
                <span class="challenge-name" id="activeChallengeName">Challenge</span>
            </div>
            <div class="challenge-progress-bar">
                <div class="challenge-progress-fill" id="activeChallengeProgress"></div>
            </div>
            <div class="challenge-progress-text" id="activeChallengeText">0/10</div>
        </div>

        <!-- Challenge Completion Celebration -->
        <div id="challengeCompleteOverlay" class="challenge-complete-overlay" style="display: none;">
            <div class="challenge-complete-content">
                <div class="challenge-complete-icon">ðŸ†</div>
                <div class="challenge-complete-title">Challenge Complete!</div>
                <div class="challenge-complete-name" id="completedChallengeName">Consistency King</div>
                <div class="challenge-complete-reward" id="completedChallengeReward">Unlocked: Advanced Analytics</div>
                <button class="btn" onclick="closeChallengeComplete()">Continue</button>
            </div>
        </div>

        <!-- Challenges Modal -->
        <div id="challengesModal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">Challenges</div>
                    <button class="modal-close" onclick="closeChallenges()">&times;</button>
                </div>
                <div id="challengesContent">
                    <!-- Dynamic challenge list -->
                </div>
            </div>
        </div>

        <!-- Pro Comparison Modal -->
        <div id="proComparisonModal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">Compare to Pro</div>
                    <button class="modal-close" onclick="closeProComparison()">&times;</button>
                </div>
                <div id="proComparisonContent">
                    <!-- Pro selector -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Select a Pro</div>
                        <div class="pro-selector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button class="pro-card" onclick="selectPro('federer')" id="pro-federer">
                                <div class="pro-name">Roger Federer</div>
                                <div class="pro-style">Forehand, Serve, Volley</div>
                            </button>
                            <button class="pro-card" onclick="selectPro('djokovic')" id="pro-djokovic">
                                <div class="pro-name">Novak Djokovic</div>
                                <div class="pro-style">Backhand, Return, Defense</div>
                            </button>
                            <button class="pro-card" onclick="selectPro('nadal')" id="pro-nadal">
                                <div class="pro-name">Rafael Nadal</div>
                                <div class="pro-style">Forehand, Topspin, Defense</div>
                            </button>
                            <button class="pro-card" onclick="selectPro('serena')" id="pro-serena">
                                <div class="pro-name">Serena Williams</div>
                                <div class="pro-style">Serve, Power, Forehand</div>
                            </button>
                        </div>
                    </div>

                    <!-- Comparison results -->
                    <div id="proComparisonResults" style="display: none;">
                        <div class="summary-stats" style="margin-bottom: 16px;">
                            <div class="summary-stat highlight">
                                <div class="summary-stat-value" id="proSimilarityScore">--</div>
                                <div class="summary-stat-label">Similarity</div>
                            </div>
                        </div>

                        <div id="proComparisonDetails">
                            <!-- Dynamic comparison details -->
                        </div>

                        <div id="proCoachingTip" style="margin-top: 16px; padding: 12px; background: rgba(205, 255, 0, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-volt);">
                            <!-- GPT coaching insight -->
                        </div>
                    </div>

                    <div id="proComparisonEmpty" style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div style="font-size: 14px;">Complete some strokes first to compare your technique with a pro.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Modal -->
        <div id="calibrationModal" class="modal-overlay">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">Calibration Tool</div>
                    <button class="modal-close" onclick="closeCalibrationModal()">&times;</button>
                </div>
                <div id="calibrationContent">
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                        Upload professional tennis videos to calibrate the analysis thresholds.
                        Use slow-motion court-level footage for best results.
                    </p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; color: rgba(255,255,255,0.6);">Skill Level</label>
                            <select id="calibrationLabel" style="width: 100%; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white;">
                                <option value="professional">Professional</option>
                                <option value="advanced">Advanced</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="beginner">Beginner</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: rgba(255,255,255,0.6);">Player Name</label>
                            <input type="text" id="calibrationPlayer" placeholder="e.g., Djokovic" style="width: 100%; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white;">
                        </div>
                    </div>

                    <div id="calibrationUploadZone" style="border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                        <div style="font-size: 32px; margin-bottom: 12px;">ðŸŽ¬</div>
                        <div>Drop video here or click to upload</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">MP4, MOV, WebM supported</div>
                        <input type="file" id="calibrationFileInput" accept="video/*" style="display: none;">
                    </div>

                    <div id="calibrationProgress" style="display: none; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span id="calibrationStatus">Processing...</span>
                            <span id="calibrationStrokeCount">0 strokes</span>
                        </div>
                        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div id="calibrationProgressBar" style="height: 100%; background: var(--accent-volt, #CDFF00); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div id="calibrationResults" style="display: none;">
                        <!-- Results will be inserted here -->
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="showCalibrationStats()" style="flex: 1;">
                            View All Stats
                        </button>
                        <button class="btn btn-secondary" onclick="exportCalibrationData()" style="flex: 1;">
                            Export Data
                        </button>
                    </div>

                    <!-- Threshold Update Actions -->
                    <div id="thresholdUpdateSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 12px;">Apply Calibration</div>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 16px;">
                            Apply calibrated thresholds to improve stroke detection accuracy.
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="applyThresholdsToApp()" style="flex: 1; background: var(--accent-volt, #CDFF00);">
                                Apply Now
                            </button>
                            <button class="btn btn-secondary" onclick="exportThresholdUpdates()" style="flex: 1;">
                                Export Code
                            </button>
                        </div>
                        <div id="thresholdApplyStatus" style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.6);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tennis AI Application
        class TennisAI {
            constructor() {
                this.pose = null;
                this.camera = null;
                this.isReady = false;
                this.isAnalyzing = false;
                
                // Enhanced Analysis Engine
                this.enhancedAnalyzer = new EnhancedTennisAnalyzer();
                
                // DOM elements
                this.video = document.getElementById('videoElement');
                this.canvas = document.getElementById('canvasElement');
                this.ctx = this.canvas.getContext('2d');
                
                this.initializeLoadingSequence();
            }

            async initializeLoadingSequence() {
                try {
                    this.updateLoadingProgress(10, 'Loading MediaPipe libraries...');
                    await this.sleep(500);
                    
                    this.updateLoadingProgress(30, 'Initializing pose detection...');
                    await this.initializeMediaPipe();
                    
                    this.updateLoadingProgress(60, 'Setting up tennis analysis...');
                    await this.sleep(500);
                    
                    this.updateLoadingProgress(80, 'Configuring camera...');
                    await this.setupCamera();
                    
                    this.updateLoadingProgress(100, 'Ready to coach!');
                    await this.sleep(500);
                    
                    this.completeInitialization();
                    
                } catch (error) {
                    this.showError('Failed to initialize: ' + error.message);
                }
            }

            async initializeMediaPipe() {
                this.pose = new Pose({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                });

                this.pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.pose.onResults(this.onResults.bind(this));
                this.isReady = true;
            }
            async setupCamera() {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                this.video.srcObject = stream;
                
                return new Promise((resolve) => {
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        
                       this.camera = new Camera(this.video, {
                        onFrame: async () => {
                            if (this.pose) {
                                await this.pose.send({ image: this.video });
                            }
                        },
                        width: 1280,
                        height: 720
                    });
                        
                        this.camera.start();
                        resolve();
                    };
                });
            }
            onResults(results) {
                // Clear and draw camera feed
                this.ctx.save();
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(results.image, 0, 0, this.canvas.width, this.canvas.height);

                if (results.poseLandmarks) {

                // Draw pose overlay
                // Volt accent skeleton with glow effect
                this.ctx.shadowColor = 'rgba(205, 255, 0, 0.4)';
                this.ctx.shadowBlur = 8;
                drawConnectors(this.ctx, results.poseLandmarks, POSE_CONNECTIONS, {
                    color: 'rgba(205, 255, 0, 0.7)',
                    lineWidth: 2
                });
                this.ctx.shadowBlur = 0;
                drawLandmarks(this.ctx, results.poseLandmarks, {
                    color: '#FFFFFF',
                    fillColor: 'rgba(205, 255, 0, 0.9)', 
                    lineWidth: 1,
                    radius: 3
                });
                
                // Only analyze pose when user has pressed play
                if (this.isAnalyzing) {
                    const poseData = this.enhancedAnalyzer.analyzePose(results.poseLandmarks, Date.now());

                    // Draw swing trail
                    if (this.enhancedAnalyzer.poseHistory.length > 2) {
                        this.drawSwingTrail();
                    }

                    // Continuously record frames for ghost (we'll extract stroke when detected)
                    if (typeof ghostOverlay !== 'undefined') {
                        ghostOverlay.recordFrame(results.poseLandmarks, Date.now());
                    }
                }

                // Draw ghost overlay (behind current pose for visibility)
                if (typeof ghostOverlay !== 'undefined' && ghostOverlay.isEnabled()) {
                    ghostOverlay.draw(this.ctx, results.poseLandmarks);

                    // Update similarity display
                    const similarity = ghostOverlay.getSimilarityScore();
                    if (similarity !== null) {
                        this.updateGhostSimilarity(similarity);
                    }
                }
            }

                this.ctx.restore();
            }

            drawSwingTrail() {
                const path = this.enhancedAnalyzer.poseHistory.map(p => ({
                    x: p.joints.rightWrist.x * this.canvas.width,
                    y: p.joints.rightWrist.y * this.canvas.height
                }));

                if (path.length < 2) return;

                this.ctx.save();

                // Draw gradient trail (recent = brighter)
                for (let i = 1; i < path.length; i++) {
                    const alpha = i / path.length;
                    this.ctx.strokeStyle = `rgba(0, 255, 255, ${alpha})`;
                    this.ctx.lineWidth = 4;

                    this.ctx.beginPath();
                    this.ctx.moveTo(path[i - 1].x, path[i - 1].y);
                    this.ctx.lineTo(path[i].x, path[i].y);
                    this.ctx.stroke();
                }

                this.ctx.restore();
            }

            updateGhostSimilarity(similarity) {
                const display = document.getElementById('ghostSimilarityDisplay');
                const valueEl = document.getElementById('ghostSimilarityValue');

                if (!display || !valueEl) return;

                valueEl.textContent = `${similarity}%`;

                // Color code based on similarity
                valueEl.classList.remove('low', 'medium', 'high');
                if (similarity >= 80) {
                    valueEl.classList.add('high');
                } else if (similarity >= 50) {
                    valueEl.classList.add('medium');
                } else {
                    valueEl.classList.add('low');
                }
            }

            updateUI(context) {
                // Update status bar
                document.getElementById('strokeCount').textContent = context.session.strokeCount;
                document.getElementById('avgScore').textContent = context.quality.overall.toFixed(0);
                document.getElementById('consistencyScore').textContent = context.session.consistency;
                
                // Update analysis card
                document.getElementById('strokeType').textContent = 
                    context.strokeType.charAt(0).toUpperCase() + context.strokeType.slice(1);
                document.getElementById('techniqueScore').textContent = 
                    `${context.quality.overall.toFixed(0)}/100`;
                
                // Update metrics
                document.getElementById('elbowAngleMetric').textContent = 
                    `${context.technique.elbowAngleAtContact.toFixed(0)}Â°`;
                document.getElementById('hipSepMetric').textContent = 
                    `${context.technique.hipShoulderSeparation.toFixed(0)}Â°`;
                document.getElementById('stanceMetric').textContent = context.technique.stance;
                document.getElementById('weightMetric').textContent = context.technique.weightTransfer;
                
                if (context.comparison && context.comparison.skillLevel) {
        const skillLevel = context.comparison.skillLevel;
        const skillDisplay = skillLevel.charAt(0).toUpperCase() + skillLevel.slice(1);
        document.getElementById('skillLevelMetric').textContent = 
            `${skillDisplay} (${context.comparison.percentile}%)`;
    }
    
                // Show card
                const card = document.getElementById('analysisCard');
                card.classList.add('visible');
                setTimeout(() => card.classList.remove('visible'), 4000);
        }   
            

            startAnalysis() {
                if (!this.isReady) return;
                
                this.isAnalyzing = true;
                
                document.getElementById('aiStatusDot').className = 'status-dot active';
                document.getElementById('playBtn').textContent = 'â¸ï¸';
                document.getElementById('coachingText').textContent = 
                    'AI analyzing your strokes. Make tennis swings to get feedback!';
            }

            stopAnalysis() {
                this.isAnalyzing = false;
                
                document.getElementById('aiStatusDot').className = 'status-dot ready';
                document.getElementById('playBtn').textContent = 'â–¶ï¸';
                document.getElementById('coachingText').textContent = 
                    'Analysis paused. Tap play to resume.';
            }

            resetSession() {
                // End current session and show summary if strokes were recorded
                if (typeof sessionStorage !== 'undefined' && sessionStorage.endSession) {
                    const endedSession = sessionStorage.endSession();
                    if (endedSession && endedSession.summary && endedSession.summary.totalStrokes > 0) {
                        // Record session in player profile for cross-session tracking
                        if (typeof playerProfile !== 'undefined') {
                            const milestones = playerProfile.recordSession(endedSession.summary);
                            // Show milestones if any achieved
                            if (milestones && milestones.length > 0) {
                                endedSession.summary.milestones = milestones;
                            }
                        }
                        showSessionSummary(endedSession.summary);
                    }
                    // Create new session
                    sessionStorage.createSession();
                }

                // Reset GPT coach session state
                if (typeof gptVoiceCoach !== 'undefined' && gptVoiceCoach.resetSession) {
                    gptVoiceCoach.resetSession();
                }

                this.enhancedAnalyzer.resetSession();

                document.getElementById('strokeCount').textContent = '0';
                document.getElementById('avgScore').textContent = '--';
                document.getElementById('consistencyScore').textContent = '--';
                document.getElementById('elbowAngleMetric').textContent = '--';
                document.getElementById('hipSepMetric').textContent = '--';
                document.getElementById('stanceMetric').textContent = '--';
                document.getElementById('weightMetric').textContent = '--';
                document.getElementById('coachingText').textContent =
                    'Session reset! Ready to analyze your technique.';
                document.getElementById('analysisCard').classList.remove('visible');
            }

            completeInitialization() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('aiStatusDot').className = 'status-dot ready';

                // Create or restore session
                if (typeof sessionStorage !== 'undefined' && sessionStorage.createSession) {
                    const existingSession = sessionStorage.getCurrentSession();
                    if (!existingSession) {
                        sessionStorage.createSession();
                    }
                }
            }

            updateLoadingProgress(percent, status) {
                document.getElementById('loadingBar').style.width = percent + '%';
                document.getElementById('loadingStatus').textContent = status;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.getElementById('errorContainer').appendChild(errorDiv);
                
                setTimeout(() => errorDiv.remove(), 5000);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global application state
        let tennisAI = null;

        // Global functions for UI interaction
        async function requestCameraPermission() {
            try {
                document.getElementById('permissionScreen').style.display = 'none';
                document.getElementById('apiKeyScreen').style.display = 'flex';
            } catch (error) {
                document.getElementById('permissionScreen').style.display = 'flex';
                alert('Camera access denied. Please enable camera permissions and try again.');
            }
        }

        async function connectGPTCoach() {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            if (!apiKey || !apiKey.startsWith('sk-')) {
                alert('Please enter a valid OpenAI API key');
                return;
            }
            
            document.getElementById('apiKeyScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            // Initialize GPT coach
            await gptVoiceCoach.initialize(apiKey);
            
            // Continue with tennis AI initialization
            tennisAI = new TennisAI();
        }

        function skipGPTCoach() {
            document.getElementById('apiKeyScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            // Use fallback coaching
            gptVoiceCoach.fallbackToSpeechSynthesis();
            
            // Continue with tennis AI initialization
            tennisAI = new TennisAI();
        }

        function toggleAnalysis() {
            if (!tennisAI || !tennisAI.isReady) return;
            
            if (tennisAI.isAnalyzing) {
                tennisAI.stopAnalysis();
            } else {
                tennisAI.startAnalysis();
            }
        }

        function resetSession() {
            if (tennisAI) {
                tennisAI.resetSession();
            }
            // Reset ghost session tracking
            if (typeof ghostOverlay !== 'undefined') {
                ghostOverlay.resetSession();
            }
        }

        // Ghost Overlay Toggle
        function toggleGhost() {
            if (typeof ghostOverlay === 'undefined') return;

            const enabled = ghostOverlay.toggle();
            const btn = document.getElementById('ghostBtn');
            const label = document.getElementById('ghostBtnLabel');
            const display = document.getElementById('ghostSimilarityDisplay');

            if (enabled) {
                // Check if we have a ghost to show
                if (!ghostOverlay.ghostStroke) {
                    // Try to use best stroke from this session
                    if (!ghostOverlay.useBestStroke()) {
                        // No ghost available
                        alert('No ghost available yet. Complete some strokes first, and your best one will become the ghost.');
                        ghostOverlay.toggle(); // Turn back off
                        return;
                    }
                }

                btn.classList.add('active');
                label.textContent = 'GHOST ON';
                display.style.display = 'block';
                ghostOverlay.play();

                // Show ghost info
                const info = ghostOverlay.getGhostInfo();
                if (info) {
                    console.log(`Ghost active: ${info.name} (${info.frameCount} frames)`);
                }
            } else {
                btn.classList.remove('active');
                label.textContent = 'GHOST';
                display.style.display = 'none';
                ghostOverlay.pause();
            }
        }

        // Lock current best stroke as ghost reference
        function lockCurrentGhost() {
            if (typeof ghostOverlay === 'undefined' || !ghostOverlay.bestStrokeThisSession) {
                alert('No stroke to lock. Complete some strokes first.');
                return;
            }

            const stroke = ghostOverlay.lockStroke(ghostOverlay.bestStrokeThisSession);
            alert(`Locked "${stroke.name}" as a saved ghost reference!`);
        }

        // Session Summary Modal
        function showSessionSummary(summary) {
            if (!summary) return;

            const duration = formatDuration(summary.duration);
            const improvementClass = summary.improvement > 0 ? 'positive' :
                                     summary.improvement < 0 ? 'negative' : 'neutral';
            const improvementText = summary.improvement > 0 ? `+${summary.improvement}` :
                                    summary.improvement < 0 ? `${summary.improvement}` : '0';

            let html = `
                <div class="summary-stats">
                    <div class="summary-stat highlight">
                        <div class="summary-stat-value">${summary.averageScore}</div>
                        <div class="summary-stat-label">Average Score</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${summary.totalStrokes}</div>
                        <div class="summary-stat-label">Total Strokes</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${duration}</div>
                        <div class="summary-stat-label">Duration</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${summary.bestScore}</div>
                        <div class="summary-stat-label">Best Stroke</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${summary.consistency}</div>
                        <div class="summary-stat-label">Consistency</div>
                    </div>
                </div>

                <div class="summary-section">
                    <div class="summary-section-title">Session Trend</div>
                    <span class="improvement-badge ${improvementClass}">
                        ${summary.improvement > 0 ? 'â†‘' : summary.improvement < 0 ? 'â†“' : 'â†’'}
                        ${improvementText} points from start to finish
                    </span>
                </div>
            `;

            if (summary.weaknesses && summary.weaknesses.length > 0) {
                html += `
                    <div class="summary-section">
                        <div class="summary-section-title">Areas to Improve</div>
                        ${summary.weaknesses.map(w => `<span class="weakness-tag">${w}</span>`).join('')}
                    </div>
                `;
            }

            if (summary.drillRecommendation) {
                html += `
                    <div class="summary-section">
                        <div class="summary-section-title">Recommended Drill</div>
                        <div class="drill-card">
                            <div class="drill-name">${summary.drillRecommendation.name}</div>
                            <div class="drill-description">${summary.drillRecommendation.description}</div>
                            <div class="drill-duration">${summary.drillRecommendation.duration}</div>
                        </div>
                    </div>
                `;
            }

            // Show milestones if any achieved
            if (summary.milestones && summary.milestones.length > 0) {
                html += `
                    <div class="summary-section">
                        <div class="summary-section-title">Milestones Achieved!</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${summary.milestones.map(m => `
                                <span style="background: linear-gradient(135deg, var(--accent-volt), #a0cc00); color: #0A0A0A; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 13px;">
                                    ðŸ† ${m.label}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('sessionSummaryContent').innerHTML = html;
            document.getElementById('sessionSummaryModal').classList.add('visible');
        }

        function closeSessionSummary() {
            document.getElementById('sessionSummaryModal').classList.remove('visible');
        }

        // Analytics Modal
        function showAnalytics() {
            if (typeof sessionStorage === 'undefined' || !sessionStorage.getAggregatedStats) {
                alert('Session history not available');
                return;
            }

            const stats = sessionStorage.getAggregatedStats();
            const history = sessionStorage.getSessionHistory();

            // Get player profile stats
            let profileStats = null;
            if (typeof playerProfile !== 'undefined') {
                profileStats = playerProfile.getPlayerStats();
            }

            let html = '';

            if (!stats || stats.totalSessions === 0) {
                html = `
                    <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.7);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“Š</div>
                        <div style="font-size: 16px;">No session history yet</div>
                        <div style="font-size: 14px; margin-top: 8px;">Complete a practice session to see your stats</div>
                    </div>
                `;
            } else {
                const trendIcon = stats.trend === 'improving' ? 'â†‘' :
                                  stats.trend === 'declining' ? 'â†“' : 'â†’';
                const trendClass = stats.trend === 'improving' ? 'positive' :
                                   stats.trend === 'declining' ? 'negative' : 'neutral';

                html = `
                    <div class="summary-stats">
                        <div class="summary-stat highlight">
                            <div class="summary-stat-value">${stats.overallAverage}</div>
                            <div class="summary-stat-label">Avg Score (All Time)</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${stats.totalSessions}</div>
                            <div class="summary-stat-label">Sessions</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${stats.totalStrokes}</div>
                            <div class="summary-stat-label">Total Strokes</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" style="text-transform: capitalize;">${stats.mostPracticed}</div>
                            <div class="summary-stat-label">Most Practiced</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">
                                <span class="improvement-badge ${trendClass}">${trendIcon} ${stats.trend}</span>
                            </div>
                            <div class="summary-stat-label">Trend</div>
                        </div>
                    </div>
                `;

                if (stats.bestSession) {
                    const bestDate = new Date(stats.bestSession.date).toLocaleDateString();
                    html += `
                        <div class="summary-section">
                            <div class="summary-section-title">Personal Best</div>
                            <div class="drill-card">
                                <div class="drill-name">${stats.bestSession.score} Average Score</div>
                                <div class="drill-description">Achieved on ${bestDate}</div>
                            </div>
                        </div>
                    `;
                }

                // Player Profile: Milestones
                if (profileStats && profileStats.milestones && profileStats.milestones.length > 0) {
                    html += `
                        <div class="summary-section">
                            <div class="summary-section-title">Milestones</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${profileStats.milestones.slice(0, 6).map(m => `
                                    <span style="background: rgba(205, 255, 0, 0.2); color: var(--accent-volt); padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                                        ðŸ† ${m.label}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Player Profile: Areas to Improve
                if (profileStats && profileStats.weaknesses && profileStats.weaknesses.length > 0) {
                    html += `
                        <div class="summary-section">
                            <div class="summary-section-title">Focus Areas</div>
                            ${profileStats.weaknesses.slice(0, 3).map(w => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 6px;">
                                    <span style="color: white;">${w.name}</span>
                                    <span style="font-size: 12px; color: ${w.improving ? 'var(--accent-volt)' : 'rgba(255,255,255,0.5)'};">
                                        ${w.improving ? 'â†‘ Improving' : `${w.count} sessions`}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Player Profile: Stroke Proficiency
                if (profileStats && profileStats.strokeProficiency) {
                    const strokes = Object.entries(profileStats.strokeProficiency)
                        .filter(([_, data]) => data.attempts > 0)
                        .sort((a, b) => b[1].avgScore - a[1].avgScore);

                    if (strokes.length > 0) {
                        html += `
                            <div class="summary-section">
                                <div class="summary-section-title">Stroke Proficiency</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    ${strokes.map(([type, data]) => `
                                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 20px; font-weight: bold; color: var(--accent-volt);">${Math.round(data.avgScore)}</div>
                                            <div style="font-size: 12px; color: white;">${type}</div>
                                            <div style="font-size: 10px; color: rgba(255,255,255,0.5);">${data.attempts} strokes</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                // Recent Sessions
                if (history.length > 0) {
                    html += `
                        <div class="summary-section">
                            <div class="summary-section-title">Recent Sessions</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                    `;

                    history.slice(0, 10).forEach(session => {
                        const date = new Date(session.date).toLocaleDateString();
                        const time = new Date(session.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const s = session.summary;

                        if (s) {
                            html += `
                                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: bold; color: white;">${date} ${time}</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                                ${s.totalStrokes} strokes â€¢ ${formatDuration(s.duration)}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 24px; font-weight: bold; color: var(--accent-volt, #CDFF00);">${s.averageScore}</div>
                                            <div style="font-size: 10px; color: rgba(255,255,255,0.6);">${s.consistency}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });

                    html += `</div></div>`;
                }
            }

            document.getElementById('analyticsContent').innerHTML = html;
            document.getElementById('analyticsModal').classList.add('visible');
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').classList.remove('visible');
        }

        // ========================================
        // Challenge Mode Functions
        // ========================================

        function showChallenges() {
            renderChallengesList();
            document.getElementById('challengesModal').classList.add('visible');
        }

        function closeChallenges() {
            document.getElementById('challengesModal').classList.remove('visible');
        }

        function renderChallengesList() {
            if (typeof challengeMode === 'undefined') return;

            const challenges = challengeMode.getAvailableChallenges();
            const stats = challengeMode.getStats();

            let html = `
                <div style="margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 800; color: var(--accent-volt);">${stats.completed}/${stats.total}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Challenges Completed</div>
                </div>
            `;

            challenges.forEach(challenge => {
                const statusClass = challenge.isCompleted ? 'completed' : (challenge.isActive ? 'active' : '');
                const badge = challenge.isCompleted ? 'âœ“ Completed' : (challenge.isActive ? 'Active' : '');

                html += `
                    <div class="challenge-card ${statusClass}" onclick="startChallenge('${challenge.id}')">
                        <div class="challenge-card-header">
                            <span class="challenge-card-icon">${challenge.icon}</span>
                            <span class="challenge-card-title">${challenge.name}</span>
                            ${badge ? `<span class="challenge-card-badge">${badge}</span>` : ''}
                        </div>
                        <div class="challenge-card-desc">${challenge.description}</div>
                        <span class="challenge-card-difficulty ${challenge.difficulty}">${challenge.difficulty}</span>
                    </div>
                `;
            });

            document.getElementById('challengesContent').innerHTML = html;
        }

        function startChallenge(challengeId) {
            if (typeof challengeMode === 'undefined') return;

            // Don't start if already completed
            if (challengeMode.isCompleted(challengeId)) {
                return;
            }

            const challenge = challengeMode.startChallenge(challengeId);
            if (challenge) {
                closeChallenges();
                updateActiveChallengeBar();
            }
        }

        function updateActiveChallengeBar() {
            if (typeof challengeMode === 'undefined') return;

            const challengeBar = document.getElementById('activeChallengeBar');
            const info = challengeMode.getActiveChallengeInfo();

            if (!info) {
                challengeBar.style.display = 'none';
                return;
            }

            challengeBar.style.display = 'flex';
            document.getElementById('activeChallengeIcon').textContent = info.icon;
            document.getElementById('activeChallengeName').textContent = info.name;
            document.getElementById('activeChallengeText').textContent = `${info.progress}/${info.target}`;

            const progressPercent = (info.progress / info.target) * 100;
            document.getElementById('activeChallengeProgress').style.width = `${progressPercent}%`;
        }

        function recordChallengeStroke(strokeData) {
            if (typeof challengeMode === 'undefined' || !challengeMode.activeChallenge) return;

            const result = challengeMode.recordStroke(strokeData);

            if (result) {
                updateActiveChallengeBar();

                if (result.complete) {
                    showChallengeComplete(result.challenge);
                }
            }
        }

        function showChallengeComplete(challenge) {
            document.getElementById('completedChallengeName').textContent = challenge.name;
            document.getElementById('completedChallengeReward').textContent = `Reward: ${challenge.reward}`;
            document.getElementById('challengeCompleteOverlay').style.display = 'flex';

            // Hide challenge bar
            document.getElementById('activeChallengeBar').style.display = 'none';
        }

        function closeChallengeComplete() {
            document.getElementById('challengeCompleteOverlay').style.display = 'none';
        }

        // ========================================
        // Pro Comparison Functions
        // ========================================

        let selectedPro = null;

        function showProComparison() {
            document.getElementById('proComparisonModal').classList.add('visible');
            updateProComparisonDisplay();
        }

        function closeProComparison() {
            document.getElementById('proComparisonModal').classList.remove('visible');
        }

        function selectPro(proId) {
            selectedPro = proId;

            // Update UI selection
            document.querySelectorAll('.pro-card').forEach(card => card.classList.remove('selected'));
            document.getElementById(`pro-${proId}`).classList.add('selected');

            updateProComparisonDisplay();
        }

        function updateProComparisonDisplay() {
            const resultsDiv = document.getElementById('proComparisonResults');
            const emptyDiv = document.getElementById('proComparisonEmpty');
            const detailsDiv = document.getElementById('proComparisonDetails');
            const tipDiv = document.getElementById('proCoachingTip');

            // Check if we have stroke data
            if (!tennisAI || !tennisAI.enhancedAnalyzer || tennisAI.enhancedAnalyzer.sessionStats.totalStrokes === 0) {
                resultsDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }

            if (!selectedPro) {
                resultsDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                emptyDiv.innerHTML = '<div style="font-size: 14px;">Select a pro above to compare your technique.</div>';
                return;
            }

            emptyDiv.style.display = 'none';
            resultsDiv.style.display = 'block';

            // Get pro profile and user's recent stroke data
            const proReferences = tennisAI.enhancedAnalyzer.proReferences;
            const proProfile = proReferences.getPlayerProfile(selectedPro);
            const lastStroke = tennisAI.enhancedAnalyzer.lastStrokeData;

            if (!lastStroke || !proProfile) {
                resultsDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                emptyDiv.innerHTML = '<div style="font-size: 14px;">Complete a stroke to see comparison.</div>';
                return;
            }

            // Get comparison data
            const comparison = lastStroke.proComparison;
            const similarity = comparison ? Math.round(comparison.overallSimilarity * 100) : 0;

            // Update similarity score
            document.getElementById('proSimilarityScore').textContent = `${similarity}%`;

            // Build comparison details
            let html = '<div class="comparison-metrics">';

            // Velocity comparison
            const velRatio = comparison?.velocityRatio || 0;
            html += buildComparisonMetric('Racquet Speed', velRatio, 'velocity');

            // Acceleration comparison
            const accRatio = comparison?.accelerationRatio || 0;
            html += buildComparisonMetric('Acceleration', accRatio, 'acceleration');

            // Rotation comparison
            const rotRatio = comparison?.rotationRatio || 0;
            html += buildComparisonMetric('Body Rotation', rotRatio, 'rotation');

            html += '</div>';

            // Strengths and improvements
            if (comparison) {
                if (comparison.strengths.length > 0) {
                    html += `<div style="margin-top: 16px;">
                        <div style="font-size: 11px; text-transform: uppercase; color: var(--accent-volt); margin-bottom: 8px;">Your Strengths</div>
                        <div style="font-size: 13px; color: white;">${comparison.strengths.join(' â€¢ ')}</div>
                    </div>`;
                }

                if (comparison.improvements.length > 0) {
                    html += `<div style="margin-top: 12px;">
                        <div style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Focus Areas</div>
                        <div style="font-size: 13px; color: white;">${comparison.improvements.join(' â€¢ ')}</div>
                    </div>`;
                }
            }

            detailsDiv.innerHTML = html;

            // Coaching tip based on pro style
            const proTips = {
                federer: `To develop Federer-like technique, focus on fluid motion and early preparation. His forehand is built on timing and effortless power, not muscling the ball.`,
                djokovic: `Djokovic's game is built on flexibility and consistency. Work on staying low through contact and maximizing your court coverage.`,
                nadal: `To hit like Nadal, focus on extreme topspin and aggressive hip rotation. His lasso forehand comes from tremendous racquet head speed generated by the whole body.`,
                serena: `Serena's power comes from explosive leg drive and core rotation. Focus on loading your legs and driving up through the shot.`
            };

            tipDiv.innerHTML = `<div style="font-size: 13px; color: white;">${proTips[selectedPro] || 'Study the pro\'s technique and work on matching their form.'}</div>`;
        }

        function buildComparisonMetric(label, ratio, type) {
            const percent = Math.round(ratio * 100);
            const diff = percent - 100;
            const diffClass = diff >= 0 ? 'positive' : 'negative';
            const diffText = diff >= 0 ? `+${diff}%` : `${diff}%`;

            return `
                <div class="comparison-metric">
                    <div class="comparison-metric-label">${label}</div>
                    <div class="comparison-metric-values">
                        <span class="comparison-you">${percent}%</span>
                        <span class="comparison-vs">of pro</span>
                        <span class="comparison-diff ${diffClass}">${diffText}</span>
                    </div>
                </div>
            `;
        }

        // ========================================
        // Analysis Mode Functions
        // ========================================

        let currentMode = 'practice';
        let analysisVideoElement = null;
        let selectedStroke = null;

        function switchMode(mode) {
            currentMode = mode;

            // Update button states
            document.getElementById('practiceModeBtn').classList.toggle('active', mode === 'practice');
            document.getElementById('analysisModeBtn').classList.toggle('active', mode === 'analysis');

            // Toggle containers
            const practiceElements = ['videoElement', 'canvasElement'];
            const analysisContainer = document.getElementById('analysisModeContainer');

            if (mode === 'practice') {
                analysisContainer.classList.remove('active');
                document.getElementById('videoElement').style.display = 'block';
                document.getElementById('canvasElement').style.display = 'block';
                document.querySelector('.coaching-panel').style.display = 'block';
                document.querySelector('.controls').style.display = 'flex';
            } else {
                analysisContainer.classList.add('active');
                document.getElementById('videoElement').style.display = 'none';
                document.getElementById('canvasElement').style.display = 'none';
                document.querySelector('.coaching-panel').style.display = 'none';
                document.querySelector('.controls').style.display = 'none';

                // Stop practice mode analysis if running
                if (tennisAI && tennisAI.isAnalyzing) {
                    tennisAI.stopAnalysis();
                }
            }
        }

        // Video Upload Handling
        function initVideoUpload() {
            const uploadZone = document.getElementById('videoUploadZone');
            const fileInput = document.getElementById('videoFileInput');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    loadAnalysisVideo(file);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadAnalysisVideo(file);
                }
            });
        }

        async function loadAnalysisVideo(file) {
            const uploadZone = document.getElementById('videoUploadZone');
            const playerArea = document.getElementById('videoPlayerArea');
            const video = document.getElementById('analysisVideo');
            const progressOverlay = document.getElementById('analysisProgressOverlay');

            // Show player area
            uploadZone.classList.add('has-video');
            playerArea.classList.add('active');

            // Load video
            const url = URL.createObjectURL(file);
            video.src = url;
            analysisVideoElement = video;

            video.onloadedmetadata = async () => {
                // Set up canvas size
                const canvas = document.getElementById('analysisCanvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Update timeline
                updateTimelineDisplay();

                // Start analysis
                progressOverlay.classList.add('active');

                try {
                    await videoAnalyzer.initialize();
                    await videoAnalyzer.loadVideo(file);

                    const result = await videoAnalyzer.analyzeVideo((progress) => {
                        document.getElementById('analysisProgressFill').style.width = progress + '%';
                        document.getElementById('analysisProgressPercent').textContent = Math.round(progress) + '%';
                    });

                    // Add stroke markers to timeline
                    renderStrokeMarkers(result.strokes);

                    progressOverlay.classList.remove('active');
                } catch (error) {
                    console.error('Analysis failed:', error);
                    progressOverlay.classList.remove('active');
                    alert('Failed to analyze video: ' + error.message);
                }
            };

            // Set up video time update
            video.ontimeupdate = updateTimelineDisplay;
        }

        function updateTimelineDisplay() {
            const video = document.getElementById('analysisVideo');
            if (!video || !video.duration) return;

            const current = video.currentTime;
            const duration = video.duration;
            const percent = (current / duration) * 100;

            document.getElementById('timelineProgress').style.width = percent + '%';
            document.getElementById('timelinePlayhead').style.left = percent + '%';
            document.getElementById('timelineTime').textContent =
                `${formatVideoTime(current)} / ${formatVideoTime(duration)}`;
        }

        function formatVideoTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function renderStrokeMarkers(strokes) {
            const track = document.getElementById('timelineTrack');
            const video = document.getElementById('analysisVideo');

            // Remove existing markers
            track.querySelectorAll('.stroke-marker').forEach(m => m.remove());

            strokes.forEach((stroke, index) => {
                const marker = document.createElement('div');
                marker.className = `stroke-marker ${stroke.type}`;
                marker.style.left = `calc(${(stroke.time / video.duration) * 100}% - 4px)`;
                marker.title = `${stroke.type} - ${stroke.quality}`;
                marker.dataset.strokeIndex = index;

                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectStroke(stroke, index);
                });

                track.appendChild(marker);
            });
        }

        let comparisonStrokes = [];

        function selectStroke(stroke, index) {
            selectedStroke = stroke;
            selectedStroke._index = index;

            // Update marker selection
            document.querySelectorAll('.stroke-marker').forEach(m => m.classList.remove('selected'));
            document.querySelector(`.stroke-marker[data-stroke-index="${index}"]`)?.classList.add('selected');

            // Seek video to stroke time
            const video = document.getElementById('analysisVideo');
            video.currentTime = stroke.time;

            // Show stroke details
            const panel = document.getElementById('strokeDetailsPanel');
            document.getElementById('strokeDetailType').textContent = stroke.type;
            document.getElementById('strokeDetailScore').textContent = Math.round(stroke.quality);
            document.getElementById('strokeDetailScore').style.color =
                stroke.quality >= 80 ? 'var(--accent-volt, #CDFF00)' :
                stroke.quality >= 60 ? '#FF9800' : '#f44336';
            document.getElementById('strokeDetailTime').textContent = formatVideoTime(stroke.time);
            document.getElementById('strokeDetailVelocity').textContent =
                (stroke.velocity * 100).toFixed(1);

            // Update compare button state
            const isInComparison = comparisonStrokes.some(s => s._index === index);
            document.getElementById('compareBtn').textContent = isInComparison ? 'âœ“ Added' : '+ Compare';

            panel.classList.add('visible');
        }

        function hideStrokeDetails() {
            document.getElementById('strokeDetailsPanel').classList.remove('visible');
        }

        function addToComparison() {
            if (!selectedStroke) return;

            // Check if already in comparison
            const existingIndex = comparisonStrokes.findIndex(s => s._index === selectedStroke._index);
            if (existingIndex >= 0) {
                // Remove from comparison
                comparisonStrokes.splice(existingIndex, 1);
                document.getElementById('compareBtn').textContent = '+ Compare';
            } else if (comparisonStrokes.length < 2) {
                // Add to comparison
                comparisonStrokes.push({ ...selectedStroke });
                document.getElementById('compareBtn').textContent = 'âœ“ Added';
            }

            // Update comparison panel
            if (comparisonStrokes.length === 2) {
                showComparison();
            } else if (comparisonStrokes.length < 2) {
                document.getElementById('comparisonPanel').classList.remove('visible');
            }
        }

        function showComparison() {
            const s1 = comparisonStrokes[0];
            const s2 = comparisonStrokes[1];

            const scoreDiff = s2.quality - s1.quality;
            const velocityDiff = ((s2.velocity - s1.velocity) / s1.velocity * 100).toFixed(0);

            const html = `
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;">
                    <!-- Stroke 1 -->
                    <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Stroke 1</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-volt);">${Math.round(s1.quality)}</div>
                        <div style="font-size: 11px; color: white; text-transform: capitalize;">${s1.type}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5);">${formatVideoTime(s1.time)}</div>
                    </div>

                    <!-- VS / Diff -->
                    <div style="text-align: center; padding: 8px;">
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5);">DIFF</div>
                        <div style="font-size: 16px; font-weight: bold; color: ${scoreDiff >= 0 ? 'var(--accent-volt)' : '#f44336'};">
                            ${scoreDiff >= 0 ? '+' : ''}${Math.round(scoreDiff)}
                        </div>
                    </div>

                    <!-- Stroke 2 -->
                    <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase;">Stroke 2</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-volt);">${Math.round(s2.quality)}</div>
                        <div style="font-size: 11px; color: white; text-transform: capitalize;">${s2.type}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5);">${formatVideoTime(s2.time)}</div>
                    </div>
                </div>

                <div style="margin-top: 12px; font-size: 11px; color: rgba(255,255,255,0.7);">
                    Velocity: ${velocityDiff >= 0 ? '+' : ''}${velocityDiff}%
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = html;
            document.getElementById('comparisonPanel').classList.add('visible');
        }

        function clearComparison() {
            comparisonStrokes = [];
            document.getElementById('comparisonPanel').classList.remove('visible');
            document.getElementById('compareBtn').textContent = '+ Compare';
        }

        function exportHighlightReel() {
            const strokes = videoAnalyzer.detectedStrokes;
            if (!strokes || strokes.length === 0) {
                alert('No strokes detected to export');
                return;
            }

            // Get best 5 strokes
            const best5 = [...strokes]
                .sort((a, b) => b.quality - a.quality)
                .slice(0, 5);

            showExportModal('Best 5 Strokes', best5);
        }

        function exportBlooperReel() {
            const strokes = videoAnalyzer.detectedStrokes;
            if (!strokes || strokes.length === 0) {
                alert('No strokes detected to export');
                return;
            }

            // Get worst 5 strokes (for learning)
            const worst5 = [...strokes]
                .sort((a, b) => a.quality - b.quality)
                .slice(0, 5);

            showExportModal('Strokes to Improve', worst5);
        }

        function showExportModal(title, strokes) {
            const html = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 16px;">
                        Click on any stroke to jump to that moment in the video.
                    </div>
                    ${strokes.map((stroke, i) => `
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="jumpToStroke(${stroke.time})">
                            <div>
                                <div style="font-weight: bold; color: white;">#${i + 1} - ${stroke.type}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6);">${formatVideoTime(stroke.time)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: bold; color: ${stroke.quality >= 70 ? 'var(--accent-volt)' : stroke.quality >= 50 ? '#FF9800' : '#f44336'};">${Math.round(stroke.quality)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn" onclick="copyStrokeSummary(${JSON.stringify(strokes).replace(/"/g, '&quot;')})" style="width: 100%;">
                        Copy Summary to Clipboard
                    </button>
                </div>
            `;

            // Use session summary modal for this
            document.getElementById('sessionSummaryContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 18px; font-weight: bold; color: var(--accent-volt);">${title}</div>
                </div>
                ${html}
            `;
            document.querySelector('#sessionSummaryModal .modal-title').textContent = 'Export';
            document.querySelector('#sessionSummaryModal .btn').style.display = 'none';
            document.getElementById('sessionSummaryModal').classList.add('visible');
        }

        function jumpToStroke(time) {
            const video = document.getElementById('analysisVideo');
            video.currentTime = time;
            closeSessionSummary();
        }

        function copyStrokeSummary(strokes) {
            const summary = strokes.map((s, i) =>
                `${i + 1}. ${s.type} at ${formatVideoTime(s.time)} - Score: ${Math.round(s.quality)}`
            ).join('\n');

            navigator.clipboard.writeText(summary).then(() => {
                alert('Summary copied to clipboard!');
            });
        }

        function toggleVideoPlayback() {
            const video = document.getElementById('analysisVideo');
            const btn = document.getElementById('timelinePlayBtn');

            if (video.paused) {
                video.play();
                btn.textContent = 'â¸ï¸';
            } else {
                video.pause();
                btn.textContent = 'â–¶ï¸';
            }
        }

        function clearAnalysisVideo() {
            const video = document.getElementById('analysisVideo');
            const uploadZone = document.getElementById('videoUploadZone');
            const playerArea = document.getElementById('videoPlayerArea');
            const strokePanel = document.getElementById('strokeDetailsPanel');

            // Reset video
            video.src = '';
            video.pause();

            // Hide player, show upload
            playerArea.classList.remove('active');
            uploadZone.classList.remove('has-video');
            strokePanel.classList.remove('visible');

            // Clear markers
            document.querySelectorAll('.stroke-marker').forEach(m => m.remove());

            // Clean up analyzer
            videoAnalyzer.destroy();

            selectedStroke = null;
        }

        // Timeline click to seek
        function initTimelineInteraction() {
            const track = document.getElementById('timelineTrack');

            track.addEventListener('click', (e) => {
                const video = document.getElementById('analysisVideo');
                if (!video || !video.duration) return;

                const rect = track.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                video.currentTime = percent * video.duration;
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initVideoUpload();
            initTimelineInteraction();
            initCalibrationUpload();
        });

        // ========================================
        // Calibration Functions
        // ========================================

        function openCalibrationModal() {
            document.getElementById('calibrationModal').classList.add('visible');
        }

        function closeCalibrationModal() {
            document.getElementById('calibrationModal').classList.remove('visible');
            if (typeof calibrationTool !== 'undefined') {
                calibrationTool.cancel();
            }
        }

        function initCalibrationUpload() {
            const uploadZone = document.getElementById('calibrationUploadZone');
            const fileInput = document.getElementById('calibrationFileInput');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--accent-volt, #CDFF00)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'rgba(255,255,255,0.3)';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'rgba(255,255,255,0.3)';
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    startCalibration(file);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    startCalibration(file);
                }
            });
        }

        async function startCalibration(file) {
            const label = document.getElementById('calibrationLabel').value;
            const player = document.getElementById('calibrationPlayer').value || 'unknown';

            // Show progress
            document.getElementById('calibrationUploadZone').style.display = 'none';
            document.getElementById('calibrationProgress').style.display = 'block';
            document.getElementById('calibrationResults').style.display = 'none';

            try {
                // Initialize calibration tool
                await calibrationTool.initialize();

                // Run calibration
                const results = await calibrationTool.calibrateFromVideo(file, {
                    label: label,
                    player: player,
                    onProgress: (progress) => {
                        document.getElementById('calibrationProgressBar').style.width = progress.progress + '%';
                        document.getElementById('calibrationStatus').textContent =
                            `Processing... ${progress.progress.toFixed(0)}%`;
                        document.getElementById('calibrationStrokeCount').textContent =
                            `${progress.strokesDetected} strokes detected`;
                    },
                    onStrokeDetected: (stroke, count) => {
                        console.log(`Calibration stroke #${count}: ${stroke.type}`);
                    }
                });

                // Show results
                displayCalibrationResults(results);

            } catch (error) {
                console.error('Calibration failed:', error);
                document.getElementById('calibrationStatus').textContent = 'Calibration failed: ' + error.message;
            }
        }

        function displayCalibrationResults(results) {
            document.getElementById('calibrationProgress').style.display = 'none';
            document.getElementById('calibrationResults').style.display = 'block';

            if (results.error) {
                document.getElementById('calibrationResults').innerHTML = `
                    <div style="color: #f44336; padding: 20px; text-align: center;">
                        ${results.error}
                    </div>
                `;
                return;
            }

            let html = `
                <div class="summary-stats" style="margin-bottom: 20px;">
                    <div class="summary-stat highlight">
                        <div class="summary-stat-value">${results.totalStrokes}</div>
                        <div class="summary-stat-label">Strokes Detected</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${results.label}</div>
                        <div class="summary-stat-label">Skill Level</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${results.player}</div>
                        <div class="summary-stat-label">Player</div>
                    </div>
                </div>
            `;

            // Key metrics
            if (results.metrics) {
                html += `<div class="summary-section"><div class="summary-section-title">Key Metrics</div>`;
                html += `<div style="font-size: 13px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">`;

                const metricsToShow = ['velocity', 'acceleration', 'rotation', 'elbowAngle', 'hipShoulderSeparation'];
                for (const metric of metricsToShow) {
                    if (results.metrics[metric]) {
                        const m = results.metrics[metric];
                        html += `<div style="margin-bottom: 8px;">
                            <strong>${metric}:</strong>
                            avg=${m.avg.toFixed(4)}, range=[${m.min.toFixed(4)} - ${m.max.toFixed(4)}]
                        </div>`;
                    }
                }

                html += `</div></div>`;
            }

            // Recommended thresholds
            if (results.recommendedThresholds && Object.keys(results.recommendedThresholds).length > 0) {
                html += `<div class="summary-section"><div class="summary-section-title">Recommended Thresholds</div>`;
                html += `<div style="font-size: 12px; background: rgba(76,175,80,0.2); padding: 12px; border-radius: 8px; border: 1px solid rgba(76,175,80,0.3);">`;

                for (const [metric, data] of Object.entries(results.recommendedThresholds)) {
                    if (data.recommended) {
                        html += `<div style="margin-bottom: 8px;">
                            <strong>${metric}:</strong><br>
                            <span style="color: rgba(255,255,255,0.6);">Current:</span> ${JSON.stringify(data.current)}<br>
                            <span style="color: var(--accent-volt, #CDFF00);">Recommended:</span> ${JSON.stringify(data.recommended)}
                        </div>`;
                    }
                }

                html += `</div></div>`;
            }

            // Stroke type distribution
            if (results.distributions?.strokeTypes) {
                html += `<div class="summary-section"><div class="summary-section-title">Stroke Distribution</div>`;
                html += `<div style="display: flex; gap: 8px; flex-wrap: wrap;">`;
                for (const [type, count] of Object.entries(results.distributions.strokeTypes)) {
                    html += `<span style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                        ${type}: ${count}
                    </span>`;
                }
                html += `</div></div>`;
            }

            html += `
                <button class="btn" onclick="resetCalibrationUI()" style="width: 100%; margin-top: 16px;">
                    Calibrate Another Video
                </button>
            `;

            document.getElementById('calibrationResults').innerHTML = html;

            // Show threshold update section after successful calibration
            showThresholdUpdateSection();
        }

        function resetCalibrationUI() {
            document.getElementById('calibrationUploadZone').style.display = 'block';
            document.getElementById('calibrationProgress').style.display = 'none';
            document.getElementById('calibrationResults').style.display = 'none';
            document.getElementById('calibrationProgressBar').style.width = '0%';
            document.getElementById('calibrationFileInput').value = '';
            // Reset threshold update section
            document.getElementById('thresholdUpdateSection').style.display = 'none';
            document.getElementById('thresholdApplyStatus').textContent = '';
        }

        function showCalibrationStats() {
            if (typeof calibrationTool === 'undefined') return;

            const stats = calibrationTool.getAggregateStats();
            calibrationTool.printThresholdComparison();

            if (stats.error) {
                alert(stats.error);
                return;
            }

            alert(`Calibration Stats:\n\nTotal Runs: ${stats.totalRuns}\nTotal Strokes: ${stats.totalStrokes}\nLabels: ${stats.labels.join(', ')}\nPlayers: ${stats.players.join(', ')}\n\nSee console for detailed metrics.`);
        }

        function exportCalibrationData() {
            if (typeof calibrationTool !== 'undefined') {
                calibrationTool.exportCalibrationData();
            }
        }

        function applyThresholdsToApp() {
            const statusEl = document.getElementById('thresholdApplyStatus');

            if (typeof thresholdUpdater === 'undefined') {
                statusEl.textContent = 'âŒ ThresholdUpdater not loaded';
                statusEl.style.color = '#f44336';
                return;
            }

            const result = thresholdUpdater.applyToRunningApp();

            if (result.success) {
                statusEl.innerHTML = `âœ… Applied ${result.updatedModules.length} module updates!<br>` +
                    result.updatedModules.map(m => `â€¢ ${m}`).join('<br>');
                statusEl.style.color = 'var(--accent-volt, #CDFF00)';
            } else {
                statusEl.textContent = `âŒ Failed: ${result.error}`;
                statusEl.style.color = '#f44336';
            }
        }

        function exportThresholdUpdates() {
            if (typeof thresholdUpdater === 'undefined') {
                alert('ThresholdUpdater not loaded');
                return;
            }

            thresholdUpdater.exportUpdates();
        }

        function showThresholdUpdateSection() {
            const section = document.getElementById('thresholdUpdateSection');
            if (section && calibrationTool && calibrationTool.calibrationRuns.length > 0) {
                section.style.display = 'block';
            }
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes === 0) return `${remainingSeconds}s`;
            return `${minutes}m ${remainingSeconds}s`;
        }

        // Stroke quality flash function
        function flashStrokeQuality(qualityScore) {
            const overlay = document.getElementById('strokeFlashOverlay');

            // Remove existing classes
            overlay.classList.remove('flash', 'great', 'good', 'needs-work');

            // Force reflow to restart animation
            void overlay.offsetWidth;

            // Add appropriate quality class
            if (qualityScore >= 80) {
                overlay.classList.add('great');
            } else if (qualityScore >= 60) {
                overlay.classList.add('good');
            } else {
                overlay.classList.add('needs-work');
            }

            // Trigger flash animation
            overlay.classList.add('flash');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                event.preventDefault();
                toggleAnalysis();
            } else if (event.code === 'KeyR' && (event.ctrlKey || event.metaKey)) {
                event.preventDefault();
                resetSession();
            }
        });
    </script>
</body>
</html>